# Монолитное развертывание приложения

## Обзор

Приложение теперь развертывается как монолит - бэкенд и фронтенд в одном Docker контейнере с единой точкой входа.

## Архитектура

- **Бэкенд (Express)** - обрабатывает API запросы (`/api/*`)
- **Фронтенд (React)** - статические файлы раздаются через Express
- **Единый порт** - все запросы идут через порт 3000
- **SPA Routing** - все не-API запросы отдаются `index.html`

## Как это работает

1. **Сборка:**
   - Сначала собирается фронтенд (`npm run build` в `frontend/`)
   - Затем собирается бэкенд (`npm run build` в `backend/`)
   - Результат сборки фронтенда копируется в Docker образ

2. **Запуск:**
   - Express сервер запускается на порту 3000
   - API запросы (`/api/*`) обрабатываются бэкендом
   - Все остальные запросы отдают статические файлы фронтенда
   - SPA routing: все маршруты отдают `index.html`

## Преимущества

✅ Единая точка входа - один URL для всего приложения
✅ Нет проблем с CORS - same-origin запросы
✅ Проще деплой - один Docker контейнер
✅ Меньше конфигурации - не нужно настраивать прокси
✅ Лучшая производительность - нет лишних сетевых запросов

## Деплой на Railway

### 1. Настройка проекта

В Railway создайте один сервис для бэкенда:

- **Root Directory:** `backend` (или корень репозитория)
- **Dockerfile:** `backend/Dockerfile`
- **Build Context:** Корень репозитория

### 2. Переменные окружения

Добавьте все необходимые переменные окружения в Railway:

- `DATABASE_URL` - строка подключения к PostgreSQL
- `JWT_SECRET` - секретный ключ для JWT токенов
- `CORS_ORIGIN` - (опционально) разрешенные origins для CORS
- `SENTRY_DSN` - (опционально) DSN для Sentry
- `MAKE_WEBHOOK_URL` - URL для отправки webhooks в Make
- И другие переменные из `.env.example`

### 3. Деплой

После настройки Railway автоматически:
1. Соберет фронтенд
2. Соберет бэкенд
3. Запустит Express сервер
4. Раздаст фронтенд через Express

### 4. Проверка

После деплоя проверьте:

- `https://your-app.railway.app/health` - health check
- `https://your-app.railway.app/` - фронтенд должен открыться
- `https://your-app.railway.app/api/admin/auth/login` - API должен работать

## Локальная разработка

В режиме разработки фронтенд и бэкенд запускаются отдельно:

```bash
# Запустить оба сервиса
npm run dev

# Или отдельно
npm run dev:backend  # Бэкенд на порту 3000
npm run dev:frontend # Фронтенд на порту 5173 (Vite)
```

В production режиме (`NODE_ENV=production`) Express автоматически раздает статику фронтенда.

## Структура файлов в Docker

```
/app
├── dist/              # Скомпилированный бэкенд
├── frontend/
│   └── dist/         # Собранный фронтенд
├── prisma/           # Prisma схема
├── node_modules/     # Зависимости
└── package.json
```

## Troubleshooting

### Фронтенд не открывается

1. Проверьте что фронтенд собрался: `ls -la frontend/dist`
2. Проверьте логи бэкенда на наличие ошибок
3. Убедитесь что `NODE_ENV=production`

### API запросы не работают

1. Проверьте что маршруты `/api/*` настроены до статики
2. Проверьте CORS настройки
3. Проверьте логи бэкенда

### Ошибки сборки

1. Убедитесь что все зависимости установлены
2. Проверьте что TypeScript компилируется без ошибок
3. Проверьте логи сборки в Railway

## Откат к раздельному деплою

Если нужно вернуться к раздельному деплою:

1. Удалите код раздачи статики из `backend/src/index.ts`
2. Используйте отдельные Dockerfile для фронтенда и бэкенда
3. Настройте прокси между фронтендом и бэкендом

