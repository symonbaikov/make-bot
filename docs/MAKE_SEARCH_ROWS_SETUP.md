# Настройка Search Rows для проверки дубликатов в Make

## Пошаговая инструкция

### Шаг 1: Настройка модуля "Search Rows"

1. **Откройте модуль "Google Sheets - Search Rows"** в вашем сценарии

2. **В разделе "Filter" настройте фильтр:**
   - **Первое поле (Column):** Выберите `Email` из выпадающего списка
   - **Оператор (Operator):** Выберите `Equal to` (или "Равно")
   - **Второе поле (Value):** Введите `{{1.email}}` или выберите из списка переменных

   Должно получиться:

   ```
   Email Equal to {{1.email}}
   ```

3. **Нажмите "Save"** для сохранения настроек модуля

### Шаг 2: Настройка Router

После модуля "Search Rows" добавьте модуль "Router":

1. **Добавьте Router модуль:**
   - Нажмите "+" после "Search Rows"
   - Выберите "Router"

2. **Настройте первый путь (Email найден):**
   - **Название пути:** "Email уже существует"
   - **Условие:**
     ```
     {{2.Rows.length}} > 0
     ```
     или
     ```
     {{2.Rows}} is not empty
     ```
   - **Действие:** Оставьте пустым (ничего не делать) или добавьте модуль для логирования

3. **Настройте второй путь (Email не найден):**
   - **Название пути:** "Email не найден"
   - **Условие:**
     ```
     {{2.Rows.length}} = 0
     ```
     или
     ```
     {{2.Rows}} is empty
     ```
   - **Действие:** Здесь будет модуль "Add a Row"

### Шаг 3: Добавление модуля "Add a Row" в путь "Email не найден"

1. **В пути Router'а "Email не найден", нажмите "+"**

2. **Выберите "Google Sheets" → "Add a Row"**

3. **Настройте модуль:**
   - Выберите тот же Spreadsheet и лист, что и в "Search Rows"
   - Настройте маппинг полей:
     - `Email` → `{{1.email}}`
     - `First Name` → `{{1.firstName}}`
     - `Last Name` → `{{1.lastName}}`

## Итоговая структура сценария

```
Webhooks (Custom webhook) - модуль #1
    ↓
Google Sheets (Search Rows) - модуль #3
    Filter: Email = {{1.email}}
    ↓
Router - модуль #4
    ├─→ Путь 1 (1st): {{3.Rows.length}} = 0
    │   └─→ Email НЕ найден → Google Sheets (Add a Row) - модуль #2
    │       Email: {{1.email}}
    │       First Name: {{1.firstName}}
    │       Last Name: {{1.lastName}}
    │
    └─→ Путь 2 (2nd): {{3.Rows.length}} > 0
        └─→ Email найден → ничего не делать (пустой)
```

**Примечание:**

- Номера модулей могут отличаться в вашем сценарии
- Важно использовать правильный номер модуля "Search Rows" в условиях Router
- В примере выше Search Rows - это модуль #3, поэтому используется `{{3.Rows}}`

## Альтернативные варианты проверки

### Вариант 1: Проверка только по Email (рекомендуется)

```
Filter: Email Equal to {{1.email}}
```

**Плюсы:**

- Email обычно уникален для каждого пользователя
- Простая настройка
- Быстрая проверка

### Вариант 2: Проверка по Email + First Name + Last Name

Если нужно проверять точное совпадение всех трех полей:

В "Search Rows" добавьте несколько условий через "Add AND rule":

1. **Первое условие:**
   - Column: `Email`
   - Operator: `Equal to`
   - Value: `{{1.email}}`

2. **Нажмите "Add AND rule"**

3. **Второе условие:**
   - Column: `First Name`
   - Operator: `Equal to`
   - Value: `{{1.firstName}}`

4. **Нажмите "Add AND rule"**

5. **Третье условие:**
   - Column: `Last Name`
   - Operator: `Equal to`
   - Value: `{{1.lastName}}`

**Результат:**

```
Email = {{1.email}} AND First Name = {{1.firstName}} AND Last Name = {{1.lastName}}
```

## Проверка работы

### Тест 1: Новый Email

1. Отправьте данные с новым Email через Telegram бота
2. В Make сценарии:
   - "Search Rows" должен вернуть пустой результат
   - Router должен выбрать путь "Email не найден"
   - "Add a Row" должен добавить новую строку

### Тест 2: Существующий Email

1. Отправьте данные с Email, который уже есть в таблице
2. В Make сценарии:
   - "Search Rows" должен найти существующую строку
   - Router должен выбрать путь "Email уже существует"
   - Новая строка НЕ должна быть добавлена

## Troubleshooting

### Проблема: Дубликаты все еще появляются

**Проверьте:**

1. **Название колонки в Google Sheets:**
   - Должно быть точно `Email` (без пробелов, с большой буквы)
   - Проверьте, что название совпадает с тем, что в выпадающем списке Make

2. **Условие в Router:**
   - Убедитесь, что условие правильное: `{{2.Rows.length}} = 0` для пути "Email не найден"
   - Проверьте, что модуль "Add a Row" находится именно в пути "Email не найден"

3. **Логи выполнения в Make:**
   - Откройте историю выполнения сценария
   - Проверьте, что "Search Rows" возвращает правильный результат
   - Проверьте, какой путь выбирает Router

### Проблема: Router не работает правильно

**Решение:**

1. Проверьте синтаксис условия:
   - Правильно: `{{2.Rows.length}} = 0`
   - Неправильно: `{{2.Rows}} = 0` (без `.length`)

2. Альтернативный синтаксис для Make:

   ```
   {{2.Rows}} is empty
   ```

   или

   ```
   {{2.Rows}} is not empty
   ```

3. Убедитесь, что номер модуля правильный:
   - Если "Search Rows" - это модуль #2, используйте `{{2.Rows}}`
   - Если модуль #3, используйте `{{3.Rows}}`
   - Проверьте номер модуля в интерфейсе Make

### Проблема: Поиск не находит существующие записи

**Проверьте:**

1. Формат Email в таблице:
   - Убедитесь, что Email записан в правильном формате
   - Проверьте наличие лишних пробелов

2. Регистр букв:
   - Make может быть чувствителен к регистру
   - Попробуйте использовать оператор "Contains" вместо "Equal to" (менее надежно)

3. Тип данных:
   - Убедитесь, что колонка Email имеет тип "Text" в Google Sheets

## Дополнительные советы

1. **Используйте Email как уникальный идентификатор** - это самый надежный способ избежать дубликатов

2. **Проверяйте логи выполнения** в Make после каждого теста

3. **Тестируйте сценарий** перед использованием в production:
   - Сначала добавьте тестовую запись вручную
   - Затем попробуйте добавить ту же запись через бота
   - Убедитесь, что дубликат не создается

4. **Мониторьте выполнение сценария** в течение первых дней использования
