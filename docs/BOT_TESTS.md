# Тесты для Telegram бота

## Проблема

Бот перестал отвечать на команду `/start` после изменений. Для предотвращения подобных проблем добавлены юнит-тесты.

## Что было исправлено

1. **Убрано Markdown форматирование** - может вызывать ошибки парсинга в Telegram
2. **Улучшена обработка команд** - команды правильно пропускаются в text handler
3. **Добавлены тесты** - проверка работы всех обработчиков

## Запуск тестов

```bash
cd bot
npm install  # Установить зависимости (jest, ts-jest)
npm test     # Запустить все тесты
```

## Что тестируется

### 1. Команда /start (`start-handler.test.ts`)
- ✅ Инициализация сессии с флагом `waitingForPlan`
- ✅ Отправка приветственного сообщения
- ✅ Отображение кнопок с тарифами
- ✅ Обработка ошибок при отправке сообщения
- ✅ Правильные цены в сообщении (64, 97, 147 GBP)
- ✅ Отсутствие Markdown форматирования

### 2. Выбор тарифа (`plan-handler.test.ts`)
- ✅ Обработка всех трех тарифов (BASIC, STANDARD, PREMIUM)
- ✅ Сохранение тарифа и цены в сессии
- ✅ Установка валюты GBP
- ✅ Переход к запросу email
- ✅ Валидация неверных данных
- ✅ Украинские названия тарифов

### 3. Интеграционный поток (`bot-integration.test.ts`)
- ✅ Полный цикл: start -> plan -> email
- ✅ Правильность изменения состояний сессии
- ✅ Корректность передачи данных между обработчиками

### 4. Регистрация обработчиков (`bot-handlers.test.ts`)
- ✅ Все функции экспортируются
- ✅ Кнопки имеют правильные callback_data
- ✅ Украинские названия тарифов в кнопках

## Запуск перед коммитом

Рекомендуется запускать тесты перед каждым коммитом:

```bash
cd bot
npm test
```

Если тесты не проходят, значит что-то сломалось и нужно исправить перед коммитом.

## CI/CD интеграция

Тесты можно добавить в CI/CD pipeline:

```yaml
# Пример для GitHub Actions
- name: Run bot tests
  run: |
    cd bot
    npm install
    npm test
```

## Что делать если тесты падают

1. Проверьте ошибку в выводе тестов
2. Убедитесь, что все функции экспортируются правильно
3. Проверьте, что не изменились названия функций или их сигнатуры
4. Убедитесь, что не сломалась логика обработчиков
5. Проверьте типы в моках - они должны соответствовать типам Telegraf (например, `chat` должен иметь `first_name` для `PrivateChat`)

## Статус тестов

✅ **Все тесты проходят** (24 теста, 4 тестовых набора)

- ✅ `start-handler.test.ts` - 8 тестов
- ✅ `plan-handler.test.ts` - 9 тестов  
- ✅ `bot-integration.test.ts` - 2 теста
- ✅ `bot-handlers.test.ts` - 6 тестов

## Известные проблемы

- Markdown форматирование может вызывать ошибки - используйте обычный текст
- Команды должны обрабатываться до text handler - порядок регистрации важен
- Callback queries должны проверять наличие данных перед обработкой

