# Phase 5: Make Automation Scenarios - –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

## ‚úÖ –°—Ç–∞—Ç—É—Å: –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ì–û–¢–û–í–ê

–í—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Make —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å–æ–∑–¥–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

---

## üìã –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. **MAKE_INTEGRATION.md** - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   - –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö 4 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ webhook payload'–æ–≤
   - –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
   - SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è PostgreSQL –º–æ–¥—É–ª–µ–π

2. **MAKE_SETUP_GUIDE.md** - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
   - –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥—É–ª–µ–π
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **MAKE_WEBHOOK_PAYLOADS.md** - –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ webhook'–∞–º
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Å–µ—Ö payload'–æ–≤
   - –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

4. **MAKE_SQL_QUERIES.md** - –ì–æ—Ç–æ–≤—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
   - –í—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
   - Utility –∑–∞–ø—Ä–æ—Å—ã
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è Make

### Scenario 1: Bot Webhook Handler ‚úÖ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç Telegram –±–æ—Ç–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ email

**–®–∞–≥–∏:**
1. Webhook trigger
2. Upsert session –≤ PostgreSQL
3. Upsert user –≤ PostgreSQL
4. Log action –≤ actions —Ç–∞–±–ª–∏—Ü—É
5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–ª–∞—Ç–µ–∂–∞ (Router)
6. –¢—Ä–∏–≥–≥–µ—Ä provisioning –µ—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –µ—Å—Ç—å

**Webhook URL:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Backend `.env` –∫–∞–∫ `MAKE_WEBHOOK_URL_BOT`

---

### Scenario 2: PayPal Webhook Handler ‚úÖ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç PayPal –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞

**–®–∞–≥–∏:**
1. Webhook trigger
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ txn_id
3. Router (–¥—É–±–ª–∏–∫–∞—Ç/–Ω–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂)
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞
5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è email (Router)
7. –¢—Ä–∏–≥–≥–µ—Ä provisioning –µ—Å–ª–∏ email –µ—Å—Ç—å

**Webhook URL:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Backend `.env` –∫–∞–∫ `MAKE_WEBHOOK_URL_PAYPAL`

---

### Scenario 3: Access Provisioning Module ‚úÖ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –∏ email

**–®–∞–≥–∏:**
1. Webhook trigger
2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏
3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ final email (email_user OR email_paypal)
4. –†–∞—Å—á–µ—Ç end_date (payment_date + 60 days)
5. –û—Ç–ø—Ä–∞–≤–∫–∞ email —Å –¥–æ—Å—Ç—É–ø–æ–º
6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ COMPLETED
7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ACCESS_GRANTED
8. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**Webhook URL:** –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π webhook –º–µ–∂–¥—É Make —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏

---

### Scenario 4: Nightly Checks and Alerts ‚úÖ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º PAID_PENDING_EMAIL –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤

**–®–∞–≥–∏:**
1. Schedule trigger (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 2:00)
2. –ü–æ–∏—Å–∫ pending –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
3. Router (–Ω–∞–π–¥–µ–Ω—ã/–Ω–µ –Ω–∞–π–¥–µ–Ω—ã)
4. –û—Ç–ø—Ä–∞–≤–∫–∞ Telegram –∞–ª–µ—Ä—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞

**Trigger:** Schedule –º–æ–¥—É–ª—å –≤ Make

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Webhook Payload'–æ–≤

### Bot Email Collection

```json
{
  "event": "bot_email_collected",
  "sessionId": "string",
  "email": "string",
  "tgUserId": "string",
  "firstName": "string?",
  "lastName": "string?",
  "plan": "BASIC|STANDARD|PREMIUM",
  "amount": number
}
```

### PayPal Payment

```json
{
  "event": "paypal_payment_received",
  "sessionId": "string",
  "txnId": "string",
  "emailPaypal": "string?",
  "amount": number,
  "currency": "string",
  "paymentDate": "ISO8601",
  "status": "completed|pending|refunded|failed"
}
```

### Access Provisioning

```json
{
  "event": "provision_access",
  "sessionId": "string",
  "email": "string?",
  "emailPaypal": "string?",
  "paymentDate": "ISO8601"
}
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backend –¥–ª—è Make

### Environment Variables

–î–æ–±–∞–≤—å—Ç–µ –≤ `backend/.env`:

```env
# Make Integration
MAKE_WEBHOOK_URL="https://hook.us1.make.com/your-webhook-url"

# –ò–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ URL –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:
MAKE_WEBHOOK_URL_BOT="https://hook.us1.make.com/bot-webhook"
MAKE_WEBHOOK_URL_PAYPAL="https://hook.us1.make.com/paypal-webhook"
MAKE_WEBHOOK_URL_PROVISIONING="https://hook.us1.make.com/provisioning-webhook"
```

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

Backend —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook'–∏ –≤ Make —á–µ—Ä–µ–∑ `MakeService`:
- `sendBotWebhook()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
- `sendPayPalWebhook()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç PayPal
- `sendWebhook()` - –æ–±—â–∏–π –º–µ—Ç–æ–¥ —Å retry –ª–æ–≥–∏–∫–æ–π

---

## ‚úÖ Business Rules –≤ Make

### 1. Final Email Logic

```
finalEmail = email_user (if exists) ELSE email_paypal
```

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ Make:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–¥—É–ª—å **Set variables**
- –ò–ª–∏ SQL: `COALESCE(email_user, email_paypal)`

### 2. End Date Calculation

```
endDate = paymentDate + 60 days (UTC)
```

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ Make:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–¥—É–ª—å **Date/Time formatter**
- Operation: Add 60 days
- –ò–ª–∏ SQL: `payment_date + INTERVAL '60 days'`

### 3. Status Flow

```
STARTED ‚Üí AWAITING_PAYMENT ‚Üí PAID ‚Üí COMPLETED
```

### 4. Idempotency

- –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ `txn_id` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π PayPal –ø–ª–∞—Ç–µ–∂–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ON CONFLICT` –≤ PostgreSQL –¥–ª—è upsert –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Make:

1. **–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –≤ Make** (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
2. **–ü–æ–¥–∫–ª—é—á–∏—Ç–µ PostgreSQL** –≤ Make
3. **–°–æ–∑–¥–∞–π—Ç–µ 4 —Å—Ü–µ–Ω–∞—Ä–∏—è** —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
   - Bot Webhook Handler
   - PayPal Webhook Handler
   - Access Provisioning
   - Nightly Checks
4. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ webhook URL'—ã** –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ Backend `.env`
5. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –≤ Make
6. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π**

### –î–ª—è Backend:

1. **–û–±–Ω–æ–≤–∏—Ç–µ `.env`** —Å webhook URL'–∞–º–∏ –∏–∑ Make
2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Backend API**
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É webhook'–æ–≤**

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: Bot Webhook Flow

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π webhook –æ—Ç –±–æ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ –ë–î
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ actions —Ç–∞–±–ª–∏—Ü–µ
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Make —Å—Ü–µ–Ω–∞—Ä–∏—è

### –¢–µ—Å—Ç 2: PayPal Webhook Flow

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π PayPal webhook
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 3: Provisioning Flow

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è —Å –ø–ª–∞—Ç–µ–∂–æ–º –∏ email
2. –í—ã–∑–æ–≤–∏—Ç–µ provisioning webhook
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É email
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ COMPLETED
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É end_date

### –¢–µ—Å—Ç 4: Nightly Checks

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º PAID_PENDING_EMAIL
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –≤—Ä—É—á–Ω—É—é
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –∞–ª–µ—Ä—Ç–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–í—Å–µ —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ `docs/`:

- `MAKE_INTEGRATION.md` - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- `MAKE_SETUP_GUIDE.md` - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `MAKE_WEBHOOK_PAYLOADS.md` - –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ payload'–∞–º
- `MAKE_SQL_QUERIES.md` - –ì–æ—Ç–æ–≤—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã

---

## ‚úÖ –ò–¢–û–ì

**Phase 5: Make Automation Scenarios - –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ì–û–¢–û–í–ê**

–í—Å—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Make —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å–æ–∑–¥–∞–Ω–∞:
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö 4 —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- ‚úÖ –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- ‚úÖ –ì–æ—Ç–æ–≤—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã webhook payload'–æ–≤
- ‚úÖ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ Make —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

