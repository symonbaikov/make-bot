# Make Integration Guide

Это руководство описывает, как настроить Make (ранее Integromat) сценарий для автоматической записи данных пользователей из Telegram бота в Google Sheets и отображения их в dashboard веб-приложения.

## Обзор потока данных

```
Telegram Bot → Backend API → Make Webhook → Google Sheets
                                    ↓
                            Dashboard (отображает данные из БД)
```

## Шаг 1: Настройка Backend

### 1.1. Установка переменной окружения

Добавьте в `backend/.env`:

```env
MAKE_WEBHOOK_URL=https://hook.us.make.com/your-webhook-url-here
```

**Важно:** URL webhook'а вы получите после создания сценария в Make (см. Шаг 2).

### 1.2. Формат данных, отправляемых в Make

Когда пользователь заполняет данные в Telegram боте (email, имя, фамилия), backend отправляет следующий JSON в Make:

```json
{
  "event": "bot_email_collected",
  "sessionId": "session-123-abc",
  "email": "user@example.com",
  "tgUserId": "123456789",
  "firstName": "Іван",
  "lastName": "Іванов",
  "phoneNumber": "+380123456789",
  "plan": "STANDARD",
  "amount": 99.99
}
```

**Для этого сценария нам нужны только:**

- `email` - Email пользователя
- `firstName` - Имя пользователя
- `lastName` - Фамилия пользователя

Остальные поля (sessionId, tgUserId, phoneNumber, plan, amount) используются в других сценариях.

## Шаг 2: Создание Make сценария

### 2.1. Создание нового сценария

1. Войдите в Make (https://www.make.com)
2. Нажмите "Create a new scenario"
3. Назовите сценарий: "Telegram Bot → Google Sheets"

### 2.2. Добавление Webhook модуля (триггер)

1. Нажмите "+" для добавления модуля
2. Выберите "Webhooks" → "Custom webhook"
3. Нажмите "Add" для создания нового webhook
4. Назовите webhook: "Bot Data Collection"
5. Скопируйте **Webhook URL** - это URL, который нужно добавить в `backend/.env` как `MAKE_WEBHOOK_URL`
6. Нажмите "Save"

**Важно:** Сохраните этот URL - он понадобится для настройки backend!

### 2.3. Добавление модулей Google Sheets для проверки дубликатов

**Шаг 1: Добавьте модуль "Search Rows"**

1. После webhook модуля, нажмите "+"
2. Выберите "Google Sheets" → "Search Rows"
3. Подключите ваш Google аккаунт (если еще не подключен)
4. Выберите Google Spreadsheet и лист (например, "Sheet1")
5. **Настройте фильтр:**
   - В разделе "Filter" добавьте правило:
     - **Column:** `Email`
     - **Operator:** `Equal to` (или "Равно")
     - **Value:** `{{1.email}}`
   - Нажмите "Save"

**Шаг 2: Добавьте Router**

1. После модуля "Search Rows", нажмите "+"
2. Выберите "Router"
3. Настройте два пути (см. Шаг 2.5 ниже)

**Шаг 3: Добавьте модуль "Add a Row"**

1. В пути Router'а "Email не найден", нажмите "+"
2. Выберите "Google Sheets" → "Add a Row"
3. Выберите тот же Spreadsheet и лист
4. Настройте маппинг полей (см. Шаг 2.4)

### 2.4. Настройка маппинга данных

В модуле "Add a Row" настройте маппинг полей (для Telegram бота нам нужны только эти три поля):

| Поле в Google Sheets | Значение из Make  |
| -------------------- | ----------------- |
| `Email`              | `{{1.email}}`     |
| `First Name`         | `{{1.firstName}}` |
| `Last Name`          | `{{1.lastName}}`  |

**Примечание:**

- `{{1.}}` означает данные из первого модуля (webhook). Номера могут отличаться в зависимости от структуры вашего сценария.
- Если в вашей таблице есть другие колонки (Session ID, Phone Number, Plan, Amount и т.д.), они заполняются в других сценариях Make.

### 2.5. Настройка проверки дубликатов (рекомендуется)

Чтобы избежать дубликатов записей в Google Sheets, добавьте проверку перед добавлением новой строки:

1. **Добавьте модуль "Google Sheets" → "Search Rows"** перед модулем "Add a Row"
   - Подключите тот же Google аккаунт и выберите ту же таблицу
   - Выберите тот же лист (Sheet1)

2. **Настройте фильтр в "Search Rows":**

   В разделе "Filter" настройте поиск по Email:

   ```
   Column: Email
   Operator: Equal to
   Value: {{1.email}}
   ```

   Это проверит, существует ли уже запись с таким Email в таблице.

3. **Добавьте модуль "Router"** после "Search Rows"
   - Router разделит поток на два пути в зависимости от результата поиска

4. **Настройте два пути в Router:**

   **Путь 1: "Email уже существует"**
   - Условие: `{{2.Rows}}` не пусто (или `{{2.Rows.length}} > 0`)
   - Действие: Ничего не делать (или можно добавить модуль для логирования)

   **Путь 2: "Email не найден"**
   - Условие: `{{2.Rows}}` пусто (или `{{2.Rows.length}} = 0`)
   - Действие: Добавить новую строку через модуль "Add a Row"

5. **Переместите модуль "Add a Row"** в путь 2 Router'а

**Альтернативный вариант:** Если хотите проверять по комбинации Email + First Name + Last Name:

В "Search Rows" настройте фильтр с несколькими условиями (AND):

```
Email = {{1.email}} AND First Name = {{1.firstName}} AND Last Name = {{1.lastName}}
```

**Рекомендация:** Используйте только Email для проверки, так как Email обычно уникален для каждого пользователя.

### 2.6. Сохранение и активация сценария

1. Нажмите "Save" для сохранения сценария
2. Включите сценарий (переключите тумблер в положение "ON")
3. Сценарий готов к работе!

## Шаг 3: Подготовка Google Sheets

### 3.1. Создание таблицы

Создайте новую Google Spreadsheet со следующими колонками (минимум для Telegram бота):

| A     | B          | C         |
| ----- | ---------- | --------- |
| Email | First Name | Last Name |

**Примечание:** Если в вашей таблице уже есть другие колонки (Session ID, Phone Number, Plan, Amount и т.д.), они заполняются в других сценариях Make. Этот сценарий заполняет только Email, First Name и Last Name.

### 3.2. Форматирование (опционально)

- Зафиксируйте первую строку (View → Freeze → 1 row)
- Добавьте фильтры (Data → Create a filter)
- Настройте форматирование даты для колонки Timestamp

## Шаг 4: Проверка работы

### 4.1. Тестирование через Telegram бота

1. Откройте Telegram бота
2. Отправьте команду `/start <session_id>` (где `session_id` - ID существующей сессии)
3. Заполните данные:
   - Email
   - Имя
   - Фамилию
4. Проверьте в Make, что сценарий выполнился успешно
5. Проверьте в Google Sheets, что данные записались в колонки Email, First Name, Last Name

### 4.2. Проверка логов в Backend

Проверьте логи backend для подтверждения отправки webhook:

```bash
# В логах должно быть:
[info] Webhook sent to Make successfully { sessionId: 'session-123-abc' }
```

Если webhook не отправлен, проверьте:

- Правильность `MAKE_WEBHOOK_URL` в `.env`
- Доступность Make webhook URL
- Логи ошибок в backend

## Шаг 5: Отображение данных в Dashboard

### 5.1. Данные уже отображаются автоматически

Dashboard веб-приложения автоматически отображает данные из базы данных PostgreSQL:

- **Страница Payments (`/payments`):** Список всех сессий с фильтрами
- **Страница Dashboard (`/dashboard`):** Статистика и метрики

### 5.2. Структура данных в Dashboard

Dashboard показывает следующие данные из БД:

- **Session ID** - ID сессии
- **Email** - Email пользователя (приоритет: `email_user` > `email_paypal`)
- **Plan** - План (BASIC, STANDARD, PREMIUM)
- **Amount** - Сумма платежа
- **Status** - Статус сессии
- **Date** - Дата создания

### 5.3. Фильтрация и поиск

В странице Payments доступны фильтры:

- По статусу (STARTED, AWAITING_PAYMENT, PAID, COMPLETED, etc.)
- По плану (BASIC, STANDARD, PREMIUM)
- Поиск по Session ID, Email, Transaction ID
- Фильтр по дате

## Структура данных

### Данные от Telegram бота

Backend отправляет все данные, но для этого сценария используются только:

```typescript
{
  email: string;            // ✅ Email пользователя (обязательно)
  firstName?: string;       // ✅ Имя пользователя (опционально)
  lastName?: string;        // ✅ Фамилия пользователя (опционально)

  // Эти поля отправляются, но не используются в этом сценарии:
  sessionId: string;        // Используется в других сценариях
  tgUserId: string;         // Используется в других сценариях
  phoneNumber?: string;     // Используется в других сценариях
  plan: 'BASIC' | 'STANDARD' | 'PREMIUM';  // Используется в других сценариях
  amount: number;           // Используется в других сценариях
}
```

### Данные в Google Sheets (для Telegram бота)

Этот сценарий заполняет только следующие колонки:

| Колонка    | Описание             | Пример             | Источник данных   |
| ---------- | -------------------- | ------------------ | ----------------- |
| Email      | Email пользователя   | `user@example.com` | `{{1.email}}`     |
| First Name | Имя пользователя     | `Іван`             | `{{1.firstName}}` |
| Last Name  | Фамилия пользователя | `Іванов`           | `{{1.lastName}}`  |

**Примечание:** Другие колонки (Session ID, Phone Number, Plan, Amount и т.д.) заполняются в других сценариях Make.

## Troubleshooting

### Проблема: Данные не записываются в Google Sheets

**Решение:**

1. Проверьте, что Make сценарий включен (ON)
2. Проверьте логи выполнения сценария в Make
3. Проверьте подключение к Google Sheets
4. Проверьте правильность маппинга полей

### Проблема: Webhook не отправляется из Backend

**Решение:**

1. Проверьте `MAKE_WEBHOOK_URL` в `backend/.env`
2. Проверьте логи backend на наличие ошибок
3. Проверьте доступность Make webhook URL (можно протестировать через curl или Postman)

### Проблема: Данные не отображаются в Dashboard

**Решение:**

1. Проверьте, что данные сохранились в БД (через Prisma Studio или прямой SQL запрос)
2. Проверьте логи backend API
3. Проверьте консоль браузера на наличие ошибок
4. Убедитесь, что backend API доступен из frontend

### Проблема: Дубликаты в Google Sheets

**Решение:**

1. Добавьте Router в Make сценарий для проверки дубликатов (см. Шаг 2.5)
2. Используйте "Update a Row" вместо "Add a Row" если запись существует

## Дополнительные возможности

### Добавление обработки платежей PayPal

Make сценарий также может обрабатывать события платежей PayPal. Формат данных:

```json
{
  "event": "paypal_payment_received",
  "sessionId": "session-123-abc",
  "txnId": "paypal-transaction-id",
  "emailPaypal": "payer@example.com",
  "amount": 99.99,
  "currency": "USD",
  "paymentDate": "2024-01-15T10:30:00Z",
  "status": "completed"
}
```

### Интеграция с другими сервисами

Make позволяет интегрировать данные с множеством других сервисов:

- **Email уведомления** (Gmail, SendGrid)
- **CRM системы** (HubSpot, Salesforce)
- **Базы данных** (PostgreSQL, MySQL)
- **Аналитика** (Google Analytics, Mixpanel)

## Безопасность

### Рекомендации:

1. **Не храните чувствительные данные** в Google Sheets без шифрования
2. **Используйте HTTPS** для всех webhook URL
3. **Ограничьте доступ** к Google Spreadsheet только необходимым пользователям
4. **Регулярно проверяйте логи** на наличие подозрительной активности

## Поддержка

Если возникли проблемы:

1. Проверьте логи backend: `backend/logs/`
2. Проверьте логи Make сценария
3. Проверьте документацию Make: https://www.make.com/en/help
4. Обратитесь к разработчикам проекта
