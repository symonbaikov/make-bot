// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Plan {
  BASIC
  STANDARD
  PREMIUM
}

enum SessionStatus {
  STARTED
  AWAITING_PAYMENT
  PAID
  PAID_PENDING_EMAIL
  COMPLETED
  REFUNDED
  FAILED
}

enum ActionType {
  SESSION_CREATED
  EMAIL_COLLECTED
  PAYMENT_RECEIVED
  PAYMENT_VERIFIED
  ACCESS_GRANTED
  EMAIL_RESENT
  EMAIL_UPDATED
  ACCESS_MANUALLY_GRANTED
  EMAIL_SENT_ADMIN
  WEBHOOK_SENT
  WEBHOOK_FAILED
}

enum Role {
  ADMIN
  MANAGER
}

model User {
  id          String   @id @default(uuid())
  email       String?  @unique
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  phoneNumber String?  @map("phone_number")
  tgUserId    String?  @unique @map("tg_user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  sessions Session[]

  @@map("users")
}

model Session {
  id            String        @id @default(uuid())
  sessionId     String        @unique @map("session_id")
  txnId         String?       @unique @map("txn_id")
  plan          Plan
  emailUser     String?       @map("email_user")
  emailPaypal   String?       @map("email_paypal")
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("USD")
  status        SessionStatus @default(STARTED)
  paymentDate   DateTime?     @map("payment_date")
  endDate       DateTime?     @map("end_date")
  meta          Json?         @default("{}")
  userId        String?       @map("user_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  user     User?      @relation(fields: [userId], references: [id])
  actions  Action[]

  @@index([sessionId])
  @@index([txnId])
  @@index([status])
  @@index([plan])
  @@index([createdAt])
  @@map("sessions")
}

model Action {
  id        String     @id @default(uuid())
  type      ActionType
  ref       String?    // session_id, txn_id, or user_id
  payload   Json?      @default("{}")
  sessionId String?    @map("session_id")
  createdAt DateTime   @default(now()) @map("created_at")

  session Session? @relation(fields: [sessionId], references: [id])

  @@index([type])
  @@index([ref])
  @@index([sessionId])
  @@index([createdAt])
  @@map("actions")
}

model WebUser {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         Role     @default(MANAGER)
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  passwordResetCodes PasswordResetCode[]

  @@map("web_users")
}

model PasswordResetCode {
  id        String   @id @default(uuid())
  code      String   @unique
  userId    String   @map("user_id")
  email     String
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user WebUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([email])
  @@index([expiresAt])
  @@map("password_reset_codes")
}

